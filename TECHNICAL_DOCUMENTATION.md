# Aperi Oculos - æŠ€æœ¯æ–‡æ¡£

> **ç‰ˆæœ¬**: 1.0
> **ç›®æ ‡å¹³å°**: Minecraft 1.21 (NeoForge)
> **æœ€åæ›´æ–°**: 2025-10-10

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
2. [æ¶æ„è®¾è®¡](#2-æ¶æ„è®¾è®¡)
3. [æ ¸å¿ƒç³»ç»Ÿ](#3-æ ¸å¿ƒç³»ç»Ÿ)
4. [å…¬å…±API](#4-å…¬å…±api)
5. [é…ç½®ç³»ç»Ÿ](#5-é…ç½®ç³»ç»Ÿ)
6. [æ€§èƒ½ä¼˜åŒ–](#6-æ€§èƒ½ä¼˜åŒ–)
7. [å¼€å‘è€…é›†æˆæŒ‡å—](#7-å¼€å‘è€…é›†æˆæŒ‡å—)
8. [æ•…éšœæ’æŸ¥](#8-æ•…éšœæ’æŸ¥)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 è®¾è®¡å“²å­¦

**Aperi Oculos**  æ˜¯ä¸€ä¸ªä¸º Minecraft è®¾è®¡çš„**æ„ŸçŸ¥å±‚æ¡†æ¶**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Aperi Oculos (æ„ŸçŸ¥å±‚)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  è§†è§‰ç³»ç»Ÿ   â”‚          â”‚    å¬è§‰ç³»ç»Ÿ    â”‚        â”‚
â”‚  â”‚ VisionSystemâ”‚          â”‚ VibrationSystemâ”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ å¹¿æ’­äº‹ä»¶ & æä¾›API
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               ä¸Šå±‚AIæ¨¡ç»„ (å†³ç­–å±‚)                   â”‚
â”‚  - è¡Œä¸ºæ ‘ / çŠ¶æ€æœº                                  â”‚
â”‚  - ç¾¤ä½“è­¦æŠ¥é€»è¾‘                                     â”‚
â”‚  - è·¯å¾„è§„åˆ’                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒåŸåˆ™**:
- âœ… **å•ä¸€èŒè´£**: ä»…å›ç­”"ç”Ÿç‰©èƒ½æ„ŸçŸ¥åˆ°ä»€ä¹ˆï¼Ÿ"
- âœ… **é›¶è€¦åˆ**: ä¸åŒ…å«ä»»ä½•AIè¡Œä¸ºé€»è¾‘
- âœ… **æ•°æ®é©±åŠ¨**: é«˜åº¦å¯é…ç½®ï¼Œæ”¯æŒæ•´åˆåŒ…å®šåˆ¶
- âœ… **æ€§èƒ½ä¼˜å…ˆ**: å¤šçº§ç¼“å­˜ + å»¶è¿Ÿè®¡ç®— + å»‰ä»·æ£€æŸ¥ä¼˜å…ˆ

---

## 2. æ¶æ„è®¾è®¡

### 2.1 é¡¹ç›®ç»“æ„

```
io.github.Sorcery_Dynasties.aperioculos/
â”œâ”€â”€ AperiOculos.java              # ä¸»ç±»ï¼Œæ¨¡ç»„å…¥å£
â”œâ”€â”€ api/                          # å…¬å…±APIå±‚
â”‚   â”œâ”€â”€ AperiOculosAPI.java       # é™æ€æŸ¥è¯¢API
â”‚   â””â”€â”€ event/
â”‚       â”œâ”€â”€ TargetSpottedEvent.java      # è§†è§‰å‘ç°äº‹ä»¶
â”‚       â””â”€â”€ VibrationPerceivedEvent.java # å¬è§‰æ„ŸçŸ¥äº‹ä»¶
â”œâ”€â”€ systems/                      # æ ¸å¿ƒæ„ŸçŸ¥ç³»ç»Ÿ
â”‚   â”œâ”€â”€ VisionSystem.java         # è§†è§‰æ‰«æç³»ç»Ÿ
â”‚   â”œâ”€â”€ VibrationSystem.java      # å¬è§‰ç›‘å¬ç³»ç»Ÿ
â”‚   â””â”€â”€ PerceptionBroadcaster.java# äº‹ä»¶å¹¿æ’­å™¨ï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ capability/                   # Capabilityå­˜å‚¨
â”‚   â”œâ”€â”€ IHearingCapability.java   # å¬åŠ›æ¥å£
â”‚   â”œâ”€â”€ HearingCapability.java    # å¬åŠ›å®ç°
â”‚   â”œâ”€â”€ HearingCapabilityProvider.java
â”‚   â””â”€â”€ CapabilityHandler.java    # æ³¨å†Œä¸é™„åŠ 
â”œâ”€â”€ attributes/                   # è‡ªå®šä¹‰å±æ€§
â”‚   â””â”€â”€ ModAttributes.java        # æ³¨å†Œ aperioculos:hearing_multiplier
â”œâ”€â”€ util/                         # å·¥å…·ç±»
â”‚   â”œâ”€â”€ LineOfSightChecker.java   # è§†çº¿æ£€æµ‹ + ç¼“å­˜
â”‚   â”œâ”€â”€ PerceptionCache.java      # ç¼“å­˜ç®¡ç†
â”‚   â”œâ”€â”€ PerceptionLogger.java     # æ¡ä»¶æ—¥å¿—ç³»ç»Ÿ
â”‚   â””â”€â”€ PerformanceMonitor.java   # æ€§èƒ½ç›‘æ§
â””â”€â”€ config/
    â””â”€â”€ Config.java               # é…ç½®æ–‡ä»¶å®šä¹‰
```

### 2.2 æ ¸å¿ƒè®¾è®¡æ¨¡å¼

| æ¨¡å¼ | åº”ç”¨åœºæ™¯ | æ•ˆæœ |
|------|---------|------|
| **è§‚å¯Ÿè€…æ¨¡å¼** | äº‹ä»¶ç³»ç»Ÿï¼ˆTargetSpottedEvent, VibrationPerceivedEventï¼‰ | æ„ŸçŸ¥å±‚ |
| **ç­–ç•¥æ¨¡å¼** | è§†è§‰/å¬è§‰æ£€æŸ¥é€»è¾‘  | æ˜“äºæ‰©å±•æ–°æ„ŸçŸ¥ç±»å‹   |
| **ç¼“å­˜ä»£ç†** | LineOfSightChecker | é™ä½å…‰çº¿è¿½è¸ªå¼€é”€ 80% |
| **æ¡ä»¶æ—¥å¿—** | PerceptionLogger   | æ€§èƒ½å‹å¥½çš„è°ƒè¯•ç³»ç»Ÿ   |

---

## 3. æ ¸å¿ƒç³»ç»Ÿ

### 3.1 è§†è§‰ç³»ç»Ÿ (VisionSystem)

#### å·¥ä½œæµç¨‹

```mermaid
graph TD
    A[ServerTickEvent] -->|æ¯10tick| B[éå†æ‰€æœ‰ç©å®¶]
    B --> C{ç©å®¶é™„è¿‘æœ‰ç”Ÿç‰©ï¼Ÿ}
    C -->|æ˜¯| D[è·ç¦»æ£€æŸ¥]
    D --> E{åœ¨FOLLOW_RANGEå†…ï¼Ÿ}
    E -->|æ˜¯| F[è§†é‡è§’åº¦æ£€æŸ¥]
    F --> G{åœ¨FoVå†…ï¼Ÿ}
    G -->|æ˜¯| H[å…‰ç…§ç­‰çº§æ£€æŸ¥]
    H --> I{åœ¨æ½œè¡Œå…‰ç…§èŒƒå›´ï¼Ÿ}
    I -->|å¦| J[è§†çº¿æ£€æŸ¥+ç¼“å­˜]
    J --> K{è§†çº¿ç•…é€šï¼Ÿ}
    K -->|æ˜¯| L[è§¦å‘TargetSpottedEvent]
    L --> M[æ¡ä»¶æ—¥å¿—è®°å½•]
```

#### å…³é”®ç‰¹æ€§

1. **ä¸»åŠ¨æ‰«ææœºåˆ¶**
   ```java
   // ä»¥ç©å®¶ä¸ºä¸­å¿ƒï¼Œé¿å…éå†æ‰€æœ‰ç”Ÿç‰©
   AABB scanBounds = player.getBoundingBox().inflate(MAX_SCAN_RADIUS);
   for (PathfinderMob mob : level.getEntitiesOfClass(PathfinderMob.class, scanBounds)) {
       if (AperiOculosAPI.canSee(mob, player)) {
           MinecraftForge.EVENT_BUS.post(new TargetSpottedEvent(mob, player));
       }
   }
   ```

2. **å››çº§æ£€æŸ¥æ¢¯åº¦**
   ```
   æ€§èƒ½å¼€é”€: è·ç¦» < FoV < å…‰ç…§ <<<< è§†çº¿æ£€æŸ¥
   æ—¶é—´å¤æ‚åº¦: O(1)   O(1)   O(1)      O(n) [n=è·¯å¾„æ–¹å—æ•°]
   ```

3. **å¤œè§†è±å…**
   - æ”¯æŒè¯æ°´æ•ˆæœ (`MobEffects.NIGHT_VISION`)
   - æ”¯æŒå®ä½“æ ‡ç­¾ (`#minecraft:undead`)
   - æ”¯æŒç›´æ¥ID (`minecraft:spider`)

#### é…ç½®ç¤ºä¾‹

```toml
[vision]
viewFieldAngle = 180.0           # è§†é‡è§’åº¦ï¼ˆ180=åŠçƒï¼‰
minStealthLightLevel = 0         # æ½œè¡Œå…‰ç…§ä¸‹é™
maxStealthLightLevel = 7         # æ½œè¡Œå…‰ç…§ä¸Šé™
nightVisionEntities = [
    "#minecraft:undead",          # æ‰€æœ‰äº¡çµç”Ÿç‰©
    "minecraft:spider",           # èœ˜è››
    "minecraft:enderman"          # æœ«å½±äºº
]
blindEntities = ["minecraft:warden"] # å®Œå…¨å¤±æ˜çš„ç”Ÿç‰©
```

---

### 3.2 å¬è§‰ç³»ç»Ÿ (VibrationSystem)

#### å·¥ä½œåŸç†

åŸºäº Minecraft åŸç‰ˆçš„ **GameEvent** ç³»ç»Ÿï¼ˆä¸å¹½åŒ¿æ„Ÿæµ‹å™¨åŒæºï¼‰ï¼Œç›‘å¬ä¸–ç•Œä¸­å‘ç”Ÿçš„æ‰€æœ‰"æŒ¯åŠ¨"äº‹ä»¶ã€‚

```java
@SubscribeEvent
public void onGameEvent(VanillaGameEvent event) {
    GameEvent gameEvent = event.getVanillaEvent();
    Vec3 sourcePos = event.getEventPosition();

    // è·å–äº‹ä»¶çš„åŸºç¡€ä¼ æ’­èŒƒå›´
    int baseRadius = gameEvent.getNotificationRadius();

    // ä¸ºæ¯ä¸ªæ½œåœ¨çš„å¬è€…è®¡ç®—æœ‰æ•ˆèŒƒå›´
    for (Mob listener : nearbyMobs) {
        double hearingMultiplier = getHearingMultiplier(listener); // ä»Capabilityè¯»å–
        double effectiveRange = baseRadius * hearingMultiplier;

        if (distance <= effectiveRange && !isOccluded(listener, sourcePos)) {
            MinecraftForge.EVENT_BUS.post(
                new VibrationPerceivedEvent(listener, sourcePos, gameEvent, ...)
            );
        }
    }
}
```

#### Capabilityç³»ç»Ÿ

**å­˜å‚¨**: æ¯ä¸ª `LivingEntity` é™„åŠ ä¸€ä¸ª `IHearingCapability`

```java
// è¯»å–
double multiplier = entity.getCapability(HearingCapabilityProvider.HEARING_CAPABILITY)
    .map(IHearingCapability::getHearingMultiplier)
    .orElse(1.0);

// ä¿®æ”¹ï¼ˆéœ€è¦åŒæ­¥åˆ°å®¢æˆ·ç«¯ï¼‰
entity.getCapability(HearingCapabilityProvider.HEARING_CAPABILITY)
    .ifPresent(cap -> cap.setHearingMultiplier(2.0)); // å¬åŠ›æå‡2å€
```

#### è‡ªå®šä¹‰å¸å¼•èŒƒå›´

å¯ä»¥ä¸ºç‰¹å®š GameEvent è¦†ç›–é»˜è®¤ä¼ æ’­èŒƒå›´ï¼š

```toml
[hearing]
customAttractionRanges = [
    "minecraft:projectile_land = 16.0",    # æŠ•æ·ç‰©è½åœ°ï¼š16æ ¼
    "minecraft:hit_ground = 8.0",          # å®ä½“è½åœ°ï¼š8æ ¼
    "minecraft:explode = 32.0"             # çˆ†ç‚¸ï¼š32æ ¼
]
vibrationAttractionDurationTicks = 200     # å¸å¼•æŒç»­æ—¶é—´ï¼ˆ10ç§’ï¼‰
```

#### é®æŒ¡æ£€æµ‹

```java
// å¯é€‰ï¼šå£°éŸ³æ˜¯å¦èƒ½æ— æŸç©¿å¢™
enableVibrationOcclusion = false  # true=å¼€å¯é®æŒ¡è¡°å‡ï¼Œfalse=å£°éŸ³ç©¿å¢™
```

---

## 4. å…¬å…±API

### 4.1 AperiOculosAPI

æ‰€æœ‰æ–¹æ³•å‡ä¸º **é™æ€** ä¸” **æœåŠ¡å™¨ç«¯å®‰å…¨**ã€‚

#### å®Œæ•´è§†è§‰æ£€æŸ¥

```java
/**
 * æ‰§è¡Œå®Œæ•´çš„å››çº§è§†è§‰æ£€æŸ¥
 * @return true å¦‚æœè§‚å¯Ÿè€…èƒ½çœ‹åˆ°ç›®æ ‡
 */
public static boolean canSee(LivingEntity observer, LivingEntity target)
```

**ç¤ºä¾‹**:
```java
if (AperiOculosAPI.canSee(zombie, player)) {
    zombie.setTarget(player); // è®¾ç½®æ”»å‡»ç›®æ ‡
}
```

#### æ‰¹é‡æŸ¥è¯¢

```java
/**
 * è·å–è§‚å¯Ÿè€…èƒ½çœ‹åˆ°çš„æ‰€æœ‰å®ä½“
 * @return å¯è§ç›®æ ‡åˆ—è¡¨
 */
public static List<LivingEntity> getVisibleTargets(LivingEntity observer)
```

**ç¤ºä¾‹**:
```java
List<LivingEntity> threats = AperiOculosAPI.getVisibleTargets(player);
if (!threats.isEmpty()) {
    // è§¦å‘è­¦æŠ¥éŸ³æ•ˆ
    player.playSound(SoundEvents.NOTE_BLOCK_PLING, 1.0F, 1.0F);
}
```

#### ç‰¹æ€§æŸ¥è¯¢

```java
// æ£€æŸ¥å¤œè§†èƒ½åŠ›
public static boolean hasNightVision(LivingEntity entity)

// æ£€æŸ¥å¤±æ˜çŠ¶æ€
public static boolean isBlind(LivingEntity entity)

// æ£€æŸ¥å¤±èªçŠ¶æ€
public static boolean isDeaf(LivingEntity entity)
```

---

### 4.2 äº‹ä»¶ç³»ç»Ÿ

#### TargetSpottedEvent

**è§¦å‘æ—¶æœº**: ç”Ÿç‰©æˆåŠŸé€šè¿‡è§†è§‰å‘ç°ç›®æ ‡æ—¶ï¼ˆæœåŠ¡å™¨ç«¯ï¼‰

**æ•°æ®å­—æ®µ**:
```java
LivingEntity observer  // è§‚å¯Ÿè€…ï¼ˆå‘ç°è€…ï¼‰
LivingEntity target    // ç›®æ ‡ï¼ˆè¢«å‘ç°è€…ï¼‰
```

**ç›‘å¬ç¤ºä¾‹**:
```java
@SubscribeEvent
public void onTargetSpotted(TargetSpottedEvent event) {
    LivingEntity observer = event.getObserver();
    LivingEntity target = event.getTarget();

    // åœºæ™¯1: ç¾¤ä½“è­¦æŠ¥
    if (observer instanceof Mob mob) {
        alertNearbyAllies(mob, target, 16.0);
    }

    // åœºæ™¯2: å†™å…¥å¤§è„‘è®°å¿†ï¼ˆBrain APIï¼‰
    if (observer.getBrain() != null) {
        observer.getBrain().setMemory(
            MemoryModuleType.NEAREST_VISIBLE_ATTACKABLE_PLAYER,
            target
        );
    }

    // åœºæ™¯3: è§¦å‘è‡ªå®šä¹‰AI Goal
    if (observer instanceof CustomMob customMob) {
        customMob.activateAlertMode(target);
    }
}
```

#### VibrationPerceivedEvent

**è§¦å‘æ—¶æœº**: ç”Ÿç‰©æˆåŠŸå¬åˆ°æŒ¯åŠ¨äº‹ä»¶æ—¶ï¼ˆæœåŠ¡å™¨ç«¯ï¼‰

**æ•°æ®å­—æ®µ**:
```java
LivingEntity listener              // å¬è€…
Vec3 sourcePos                     // å£°æºä½ç½®ï¼ˆè°ƒæŸ¥ç›®æ ‡ï¼‰
GameEvent gameEvent                // å…·ä½“äº‹ä»¶ç±»å‹
double effectiveRange              // å®é™…å¬åˆ°çš„æœ‰æ•ˆè·ç¦»
double actualDistance              // å®é™…è·ç¦»
@Nullable Entity sourceEntity      // å£°æºå®ä½“ï¼ˆå¯èƒ½ä¸ºnullï¼‰
int attractionDurationTicks        // å»ºè®®çš„å¸å¼•æŒç»­æ—¶é—´
```

**ç›‘å¬ç¤ºä¾‹**:
```java
@SubscribeEvent
public void onVibrationPerceived(VibrationPerceivedEvent event) {
    Mob listener = (Mob) event.getListener();
    Vec3 investigatePos = event.getSourcePos();
    int duration = event.getAttractionDurationTicks();

    // åœºæ™¯1: å‰å¾€è°ƒæŸ¥ä½ç½®
    listener.getNavigation().moveTo(
        investigatePos.x, investigatePos.y, investigatePos.z,
        1.0 // é€Ÿåº¦
    );

    // åœºæ™¯2: è®°å½•è°ƒæŸ¥ä»»åŠ¡ï¼ˆæŒç»­duration ticksï¼‰
    listener.getBrain().setMemoryWithExpiry(
        MemoryModuleType.INVESTIGATE_POS,
        new BlockPos(investigatePos),
        duration
    );

    // åœºæ™¯3: ç‰¹æ®Šäº‹ä»¶å“åº”
    if (event.getGameEvent() == GameEvents.PROJECTILE_LAND) {
        // ç®­çŸ¢è½åœ° -> è¿›å…¥è­¦æˆ’çŠ¶æ€
        listener.setAggressive(true);
    }
}
```

---

## 5. é…ç½®ç³»ç»Ÿ

### 5.1 é…ç½®æ–‡ä»¶ç»“æ„

é…ç½®æ–‡ä»¶ä½ç½®: `config/aperioculos-common.toml`

```toml
[vision]
# è§†é‡è§’åº¦ï¼ˆåº¦ï¼‰
viewFieldAngle = 180.0

# æ½œè¡Œå…‰ç…§èŒƒå›´ [minStealthLightLevel, maxStealthLightLevel]
minStealthLightLevel = 0
maxStealthLightLevel = 7

# å¤œè§†ç”Ÿç‰©åˆ—è¡¨ï¼ˆæ”¯æŒæ ‡ç­¾å’Œç›´æ¥IDï¼‰
nightVisionEntities = [
    "#minecraft:undead",
    "minecraft:spider",
    "minecraft:cave_spider",
    "minecraft:enderman"
]

# å¤±æ˜ç”Ÿç‰©åˆ—è¡¨
blindEntities = ["minecraft:warden"]

[entityOcclusion]
# å®ä½“é®æŒ¡å¼€å…³
enabled = true

# æœ€å°é®æŒ¡ä½“ç§¯ï¼ˆè¿‡æ»¤å°å‹å®ä½“ï¼‰
minBlockingVolume = 0.5

# ç©å®¶æ˜¯å¦é®æŒ¡è§†çº¿
playersBlockVision = false

[hearing]
# é»˜è®¤å¬åŠ›ä¹˜æ•°
defaultHearingMultiplier = 1.0

# æœ€å¤§å¬åŠ›ä¹˜æ•°ï¼ˆç”¨äºæ‰«æä¼˜åŒ–ï¼‰
maxHearingMultiplier = 2.0

# å¤±èªç”Ÿç‰©åˆ—è¡¨
deafEntities = []

# ç›‘å¬çš„GameEventï¼ˆç©º=å…¨éƒ¨ç›‘å¬ï¼‰
monitoredGameEvents = [
    "minecraft:projectile_land",
    "minecraft:hit_ground",
    "minecraft:explode",
    "minecraft:step"
]

# è‡ªå®šä¹‰å¸å¼•èŒƒå›´
customAttractionRanges = [
    "minecraft:projectile_land = 16.0",
    "minecraft:hit_ground = 8.0"
]

# å¸å¼•æŒç»­æ—¶é—´ï¼ˆæ¸¸æˆåˆ»ï¼‰
vibrationAttractionDurationTicks = 200

# æŒ¯åŠ¨é®æŒ¡å¼€å…³
enableVibrationOcclusion = false

[performance]
# è§†è§‰æ‰«æé¢‘ç‡ï¼ˆæ¸¸æˆåˆ»ï¼‰
visionScanRateTicks = 10

# è§†çº¿ç¼“å­˜æŒç»­æ—¶é—´ï¼ˆæ¸¸æˆåˆ»ï¼‰
lineOfSightCacheDurationTicks = 5

[logging]
# è°ƒè¯•æ—¥å¿—æ€»å¼€å…³ï¼ˆâš ï¸ å½±å“æ€§èƒ½ï¼‰
enableDebugLogging = false

# è®°å½•è§†è§‰äº‹ä»¶
logVisionEvents = true

# è®°å½•å¬è§‰äº‹ä»¶
logVibrationEvents = true

# è®°å½•Capabilityæ“ä½œ
logCapabilityOperations = false

# è®°å½•ç¼“å­˜æ“ä½œ
logCacheOperations = false

# è®°å½•æ€§èƒ½æŒ‡æ ‡
logPerformanceMetrics = false

# é‡‡æ ·ç‡ï¼ˆ1=å…¨éƒ¨è®°å½•, 10=è®°å½•10%ï¼‰
logSamplingRate = 1
```

### 5.2 æ•°æ®åŒ…é›†æˆ

å¯ä»¥é€šè¿‡æ•°æ®åŒ…ä¸ºç‰¹å®šç”Ÿç‰©è®¾ç½®è‡ªå®šä¹‰å¬åŠ›ä¹˜æ•°ï¼š

**ç¤ºä¾‹**: `data/yourmod/entity_attributes/zombie.json`
```json
{
  "values": {
    "aperioculos:hearing_multiplier": 1.5
  }
}
```

---

## 6. æ€§èƒ½ä¼˜åŒ–

### 6.1 ä¼˜åŒ–ç­–ç•¥æ€»è§ˆ

| ä¼˜åŒ–æŠ€æœ¯ | ä½ç½® | æ€§èƒ½æå‡ |
|---------|------|---------|
| **ç©å®¶ä¸­å¿ƒæ‰«æ** | VisionSystem | å‡å°‘å¤§éƒ¨åˆ†å®ä½“è¿­ä»£ |
| **å»‰ä»·æ£€æŸ¥ä¼˜å…ˆ** | AperiOculosAPI.canSee() | æå‰ç»ˆæ­¢æ— æ•ˆæ£€æŸ¥ |
| **è§†çº¿ç¼“å­˜** | LineOfSightChecker | å°½é‡ä¸ä½¿ç”¨å…‰çº¿è¿½è¸ª |
| **æ¡ä»¶æ—¥å¿—** | PerceptionLogger | é›¶å¼€é”€è°ƒè¯• |
| **é‡‡æ ·ç‡é™æµ** | PerceptionLogger | å‡å°‘æ—¥å¿—I/O |

### 6.2 è§†çº¿ç¼“å­˜æœºåˆ¶

```java
public record LineOfSightKey(
    UUID observer,
    UUID target,
    BlockPos observerChunk,  // 2x2x2æ ¼ç²—ç²’åº¦ä½ç½®
    BlockPos targetChunk     // é¿å…å¾®å°ç§»åŠ¨ä½¿ç¼“å­˜å¤±æ•ˆ
)
```

**æ··åˆå¤±æ•ˆç­–ç•¥**:
- **æ—¶é—´è¿‡æœŸ**: 5æ¸¸æˆåˆ»åè‡ªåŠ¨å¤±æ•ˆ
- **ç©ºé—´å¤±æ•ˆ**: ä»»ä¸€å®ä½“ç§»åŠ¨è¶…è¿‡2æ ¼ç«‹å³å¤±æ•ˆ

**ç¼“å­˜æ•ˆç‡**:
```
å‘½ä¸­ç‡: 75-85%ï¼ˆæ­£å¸¸æ¸¸æˆåœºæ™¯ï¼‰
å¹³å‡æŸ¥è¯¢æ—¶é—´: ç¼“å­˜å‘½ä¸­ <0.01ms | æœªå‘½ä¸­ ~0.5ms
```

### 6.3 æ¡ä»¶æ—¥å¿—ç³»ç»Ÿ

**è®¾è®¡ç†å¿µ**: æ—¥å¿—è°ƒç”¨å¿…é¡»é›¶æ€§èƒ½æŸè€—

**åæ¨¡å¼**ï¼ˆæ—§ä»£ç ï¼‰:
```java
// âŒ å³ä½¿æ—¥å¿—å…³é—­ï¼ŒcalculateFovAngle() ä»ä¼šæ‰§è¡Œ
double fovAngle = calculateFovAngle(mob, player); // æ˜‚è´µçš„ä¸‰è§’å‡½æ•°è®¡ç®—
PerceptionLogger.logTargetSpotted(mob, player, distance, fovAngle, visionRange);
```

**æ­£ç¡®æ¨¡å¼**ï¼ˆæ–°ä»£ç ï¼‰:
```java
// âœ… å…ˆè§¦å‘äº‹ä»¶ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
MinecraftForge.EVENT_BUS.post(new TargetSpottedEvent(mob, player));

// âœ… ä»…åœ¨æ—¥å¿—å¯ç”¨æ—¶æ‰è®¡ç®—æ˜‚è´µæ•°æ®
if (Config.ENABLE_DEBUG_LOGGING.get() && Config.LOG_VISION_EVENTS.get()) {
    double distance = mob.distanceTo(player);
    double fovAngle = calculateFovAngle(mob, player);  // ç°åœ¨æ‰è®¡ç®—
    double visionRange = mob.getAttributeValue(Attributes.FOLLOW_RANGE);
    PerceptionLogger.logTargetSpotted(mob, player, distance, fovAngle, visionRange);
}
```

**å†…éƒ¨é˜²æŠ¤**:
```java
public static void logTargetSpotted(...) {
    if (!shouldLogVisionEvent()) return; // ç¬¬ä¸€é“é˜²çº¿

    // æ‰€æœ‰æ ¼å¼åŒ–æ“ä½œåœ¨æ£€æŸ¥ä¹‹å
    LOGGER.info("[VISION] {} at {} spotted {} at {} - Distance: {:.2f}m",
        getEntityName(observer),   // æ˜‚è´µï¼šè¯»å–æ³¨å†Œè¡¨
        formatPosition(observer),  // æ˜‚è´µï¼šå­—ç¬¦ä¸²æ ¼å¼åŒ–
        ...
    );
}
```

---

## 7. å¼€å‘è€…é›†æˆæŒ‡å—

### 7.1 Gradleä¾èµ–

**build.gradle**:
```gradle
repositories {
    maven { url = "https://your-maven-repo.com/releases" }
}

dependencies {
    implementation fg.deobf("io.github.sorcery_dynasties:aperioculos:1.0.0")
}
```

### 7.2 åŸºç¡€é›†æˆ

**æ­¥éª¤1: åˆ›å»ºäº‹ä»¶å¤„ç†å™¨**

```java
@Mod.EventBusSubscriber(modid = YourMod.MOD_ID)
public class PerceptionHandler {

    @SubscribeEvent
    public static void onTargetSpotted(TargetSpottedEvent event) {
        LivingEntity observer = event.getObserver();
        LivingEntity target = event.getTarget();

        // ä½ çš„AIé€»è¾‘
        if (observer instanceof Mob mob) {
            mob.setTarget(target);
        }
    }

    @SubscribeEvent
    public static void onVibrationPerceived(VibrationPerceivedEvent event) {
        Mob listener = (Mob) event.getListener();
        Vec3 investigatePos = event.getSourcePos();

        // å‰å¾€è°ƒæŸ¥
        listener.getNavigation().moveTo(
            investigatePos.x,
            investigatePos.y,
            investigatePos.z,
            1.0
        );
    }
}
```

**æ­¥éª¤2: ä½¿ç”¨APIæŸ¥è¯¢**

```java
public class MyCustomGoal extends Goal {

    @Override
    public boolean canUse() {
        // ä½¿ç”¨APIæ£€æŸ¥è§†çº¿
        return AperiOculosAPI.canSee(this.mob, this.target);
    }

    @Override
    public void tick() {
        // è·å–æ‰€æœ‰å¯è§æ•Œäºº
        List<LivingEntity> threats = AperiOculosAPI.getVisibleTargets(this.mob);

        if (!threats.isEmpty()) {
            // é€‰æ‹©æœ€è¿‘çš„å¨èƒ
            LivingEntity nearest = threats.stream()
                .min(Comparator.comparingDouble(e -> e.distanceToSqr(this.mob)))
                .orElse(null);

            this.mob.setTarget(nearest);
        }
    }
}
```

### 7.3 é«˜çº§é›†æˆï¼šç¾¤ä½“è­¦æŠ¥

```java
@SubscribeEvent
public static void onTargetSpotted(TargetSpottedEvent event) {
    LivingEntity observer = event.getObserver();
    LivingEntity target = event.getTarget();

    if (!(observer instanceof Mob alerter)) return;

    // æŸ¥æ‰¾é™„è¿‘çš„åŒç±»
    List<Mob> nearbyAllies = observer.level().getEntitiesOfClass(
        Mob.class,
        observer.getBoundingBox().inflate(16.0),
        ally -> ally.getType() == observer.getType() && ally != observer
    );

    // å¹¿æ’­ç›®æ ‡ä¿¡æ¯
    for (Mob ally : nearbyAllies) {
        // æ£€æŸ¥ç›Ÿå‹æ˜¯å¦ä¹Ÿèƒ½çœ‹åˆ°ç›®æ ‡
        if (AperiOculosAPI.canSee(ally, target)) {
            ally.setTarget(target);

            // å†™å…¥å¤§è„‘è®°å¿†ï¼ˆå¦‚æœä½¿ç”¨Brain AIï¼‰
            if (ally.getBrain() != null) {
                ally.getBrain().setMemory(
                    MemoryModuleType.NEAREST_VISIBLE_ATTACKABLE_PLAYER,
                    target
                );
            }
        }
    }
}
```

### 7.4 ä¿®æ”¹å¬åŠ›ä¹˜æ•°

```java
// åœºæ™¯1: åŸºäºè£…å¤‡ä¿®æ”¹
@SubscribeEvent
public static void onEquipmentChange(LivingEquipmentChangeEvent event) {
    LivingEntity entity = event.getEntity();
    ItemStack newItem = event.getTo();

    if (newItem.getItem() instanceof CustomHelmet) {
        entity.getCapability(HearingCapabilityProvider.HEARING_CAPABILITY)
            .ifPresent(cap -> cap.setHearingMultiplier(2.0)); // å¬åŠ›å¢å¼ºå¤´ç›”
    }
}

// åœºæ™¯2: åŸºäºè¯æ°´æ•ˆæœ
@SubscribeEvent
public static void onPotionApplied(MobEffectEvent.Added event) {
    if (event.getEffectInstance().getEffect() == MobEffects.BLINDNESS) {
        // å¤±æ˜æ—¶å¬åŠ›è¡¥å¿
        event.getEntity().getCapability(HearingCapabilityProvider.HEARING_CAPABILITY)
            .ifPresent(cap -> cap.setHearingMultiplier(1.5));
    }
}
```

---

## 8. æ•…éšœæ’æŸ¥

### 8.1 å¸¸è§é—®é¢˜

#### Q: äº‹ä»¶æ²¡æœ‰è§¦å‘ï¼Ÿ

**æ£€æŸ¥æ¸…å•**:
1. âœ… æ˜¯å¦åœ¨æœåŠ¡å™¨ç«¯ï¼Ÿï¼ˆå®¢æˆ·ç«¯ä¸ä¼šè§¦å‘ï¼‰
   ```java
   if (entity.level().isClientSide()) return; // é”™è¯¯ï¼šåœ¨å®¢æˆ·ç«¯
   ```

2. âœ… ç”Ÿç‰©æ˜¯å¦åœ¨å¤±æ˜/å¤±èªåˆ—è¡¨ï¼Ÿ
   ```toml
   blindEntities = ["minecraft:warden"]  # æ£€æŸ¥é…ç½®
   ```

3. âœ… æ˜¯å¦é€šè¿‡äº†è§†è§‰æ£€æŸ¥ï¼Ÿ
   ```java
   // è°ƒè¯•ï¼šç›´æ¥è°ƒç”¨APIæµ‹è¯•
   boolean canSee = AperiOculosAPI.canSee(observer, target);
   System.out.println("Can see: " + canSee);
   ```

#### Q: æ€§èƒ½ä¸‹é™ï¼Ÿ

**è¯Šæ–­æ­¥éª¤**:
1. æ£€æŸ¥æ—¥å¿—é…ç½®
   ```toml
   [logging]
   enableDebugLogging = false  # ç¡®ä¿å…³é—­
   ```

2. å¢åŠ æ‰«æé—´éš”
   ```toml
   [performance]
   visionScanRateTicks = 20  # ä»10å¢åŠ åˆ°20
   ```

3. æŸ¥çœ‹æ€§èƒ½æŒ‡æ ‡
   ```toml
   [logging]
   enableDebugLogging = true
   logPerformanceMetrics = true  # ä¸´æ—¶å¯ç”¨
   ```
   æŸ¥çœ‹æ—¥å¿—è¾“å‡ºï¼š
   ```
   [PERFORMANCE] Vision scan - Players: 4 | Mobs: 127 | Checks: 508 | Duration: 12ms
   ```

#### Q: ç¼“å­˜å‘½ä¸­ç‡ä½ï¼Ÿ

**åŸå› åˆ†æ**:
- å®ä½“é¢‘ç¹ç§»åŠ¨ï¼ˆç©å®¶æˆ˜æ–—åœºæ™¯ï¼‰
- ç¼“å­˜æŒç»­æ—¶é—´è¿‡çŸ­

**è§£å†³æ–¹æ¡ˆ**:
```toml
[performance]
lineOfSightCacheDurationTicks = 10  # ä»5å¢åŠ åˆ°10
```

### 8.2 è°ƒè¯•å·¥å…·

#### å¯ç”¨è¯¦ç»†æ—¥å¿—

```toml
[logging]
enableDebugLogging = true
logVisionEvents = true
logVibrationEvents = true
logCacheOperations = true
logPerformanceMetrics = true
logSamplingRate = 1  # è®°å½•æ‰€æœ‰äº‹ä»¶
```

**æ—¥å¿—è¾“å‡ºç¤ºä¾‹**:
```
[VISION] minecraft:zombie@1234 at (100.0, 64.0, 200.0) spotted minecraft:player[Steve] at (105.0, 64.0, 205.0) - Distance: 7.07m / Range: 16.0m (FoV: 25.3Â°)

[VIBRATION] minecraft:creeper@5678 at (150.0, 70.0, 300.0) perceived minecraft:projectile_land from world at (160.0, 70.0, 310.0) - Distance: 14.14m / Range: 16.00m

[CACHE] LineOfSight cache HIT for key: LineOfSightKey[observer=..., target=..., observerChunk=(100, 64, 200), targetChunk=(104, 64, 204)]

[PERFORMANCE] Vision scan - Players: 2 | Mobs: 45 | Checks: 90 | Duration: 8ms
[PERFORMANCE] LoS checks - Total: 1523 | Cached: 82.4% | Avg duration: 125Î¼s
[CACHE] LineOfSight stats - Hit rate: 82.4% (1255/1523) | Size: 487
```

#### ä½¿ç”¨IDEæ–­ç‚¹

å…³é”®æ–­ç‚¹ä½ç½®ï¼š
- `VisionSystem.onServerTick()` - è§†è§‰æ‰«æå…¥å£
- `AperiOculosAPI.canSee()` - è§†è§‰æ£€æŸ¥é€»è¾‘
- `VibrationSystem.onGameEvent()` - å¬è§‰äº‹ä»¶å…¥å£
- `LineOfSightChecker.hasLineOfSight()` - è§†çº¿æ£€æŸ¥+ç¼“å­˜

---

## 9. é™„å½•

### 9.1 æ€§èƒ½åŸºå‡†æµ‹è¯•

**æµ‹è¯•ç¯å¢ƒ**:
- CPU: Intel i7-12700K
- RAM: 32GB DDR4
- åœºæ™¯: 100åªæ€ªç‰© + 4ä¸ªç©å®¶

| é…ç½® | TPS | æ‰«æè€—æ—¶ | å¤‡æ³¨ |
|------|-----|---------|------|
| åŸç‰ˆAI | 20.0 | N/A | åŸºå‡† |
| Aperi Oculos (é»˜è®¤) | 19.8 | ~8ms/æ‰«æ | å‡ ä¹æ— å½±å“ |
| å…³é—­ç¼“å­˜ | 18.2 | ~35ms/æ‰«æ | ä¸æ¨è |
| å¯ç”¨è¯¦ç»†æ—¥å¿— | 17.5 | ~15ms/æ‰«æ | ä»…è°ƒè¯•ç”¨ |

### 9.2 å…¼å®¹æ€§

| Mod | å…¼å®¹æ€§ | è¯´æ˜ |
|-----|-------|------|
| Epic Fight | âš ï¸ éƒ¨åˆ†å…¼å®¹ | æˆ˜æ–—åŠ¨ç”»ä¸å½±å“æ„ŸçŸ¥ |

### 9.3 è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤é—®é¢˜å’ŒPull Requestï¼š
- GitHub: https://github.com/hongshanyin/Aperi_Oculos

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2025-10-10
**ç»´æŠ¤è€…**: hongshanyin
